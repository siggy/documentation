<!DOCTYPE html>
<html lang="en-us">

<head>
  

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>

<link rel="shortcut icon" type="image/png" href="/favicon.ico"/>


<link rel='stylesheet' href='https://documentation.sig.gy/style.min.cecbfb877aac6e34ddc570567aec4b24462631741adce40ae5ab27c8087c8318.css'>


<script src='https://documentation.sig.gy/main.min.0b774fda2366fc06803dd619b7467da11181c73a4ef394b7610a2eb2a3cb7b5d.js' async></script>


  <title>迁移到新机器 - Mastodon documentation</title>

  <meta property="og:type" content="article">
  <meta property="og:url" content="https://documentation.sig.gy/zh-cn/admin/migrating/">

  
    <meta name="description" content="在不损失任何东西的情况下，把你的Mastodon复制安装至新的服务器上。">
    <meta property="og:description" content="在不损失任何东西的情况下，把你的Mastodon复制安装至新的服务器上。">
    <meta name="twitter:description" content="在不损失任何东西的情况下，把你的Mastodon复制安装至新的服务器上。">
  

  <meta name="twitter:title" content="迁移到新机器">
  <meta name="twitter:site" content="@joinmastodon">

  <link rel="canonical" href="https://documentation.sig.gy/zh-cn/admin/migrating/">
</head>

<body>
  <div class="container sidebar-layout">
    <nav class="sidebar"><a class="brand" href="/">
  <img class="link-logo" src="/brand.svg" alt="Mastodon" />
</a>

<ul>
  
  
    <li>
      
        <a href="/zh-cn/" class="">什么是Mastodon？</a>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">使用Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/zh-cn/user/signup/" class="">创建一个帐户</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/profile/" class="">设置个人资料</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/posting/" class="">发布嘟文</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/network/" class="">使用社交功能</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/moderating/" class="">处理不想要的内容</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/discoverability/" class="">推广自己和他人</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/preferences/" class="">设置你的首选项</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/contacts/" class="">更多设置</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/external/" class="">站外使用Mastodon</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/moving/" class="">迁移或删除帐户</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/user/run-your-own/" class="">运行自己的服务器</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">运营Mastodon</span>
      

      
        <ul class="sub-menu">
          
            <li>
              <a href="/zh-cn/admin/prerequisites/" class="">准备你的机器</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/install/" class="">从源中安装</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/config/" class="">设置你的环境</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/optional/" class="">安装可选特色功能</a>

              
                <ul class="sub-menu">
                  
                    <li>
                      <a href="/zh-cn/admin/optional/elasticsearch/" class="">全文搜索</a>
                    </li>
                  
                    <li>
                      <a href="/zh-cn/admin/optional/tor/" class="">匿名服务</a>
                    </li>
                  
                    <li>
                      <a href="/zh-cn/admin/optional/sso/" class="">单点登录（SSO）</a>
                    </li>
                  
                </ul>
              
            </li>
          
            <li>
              <a href="/zh-cn/admin/setup/" class="">配置你的新实例</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/tootctl/" class="">使用管理命令行</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/upgrading/" class="">升级到新版本</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/backups/" class="">备份你的服务器</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/migrating/" class="active">迁移到新机器</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/scaling/" class="">伸缩你的服务器</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/moderation/" class="">运营操作</a>

              
            </li>
          
            <li>
              <a href="/zh-cn/admin/troubleshooting/" class="">故障分析</a>

              
            </li>
          
        </ul>
      
    </li>
  
    <li>
      
        <span class="sub-title">开发Mastodon应用</span>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">向Mastodon项目做贡献</span>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">遵循的标准</span>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">REST API</span>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">API 方法</span>
      

      
    </li>
  
    <li>
      
        <span class="sub-title">API 实体</span>
      

      
    </li>
  
</ul>
</nav>
    <main>
  <h1>迁移到新机器</h1>

  
    <p>在不损失任何东西的情况下，把你的Mastodon复制安装至新的服务器上。</p>
  
  <aside>
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#basic-steps">基本步骤</a></li>
        <li><a href="#detailed-steps">详细步骤</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>
  <div class="e-content">
    <p>有时，出于各种原因，你需要将你的Mastodon实例从一台服务器迁移至另一台。幸运的是，这个过程并不太困解，虽然这可能导致一段时间的下线。</p>
<div class="hint hint-info">
  <div class="hint-icon"><i class="fa fa-info-circle"></i></div>

  本篇指南基于Ubuntu Server编写；根据其他设置的不同，你的过程可能会有变化。
</div>

<h2 id="basic-steps">基本步骤</h2>
<ol>
<li>依照<a href="/zh-cn/admin/install/">产品指南</a>安装新的Mastodon服务器（切记，不要运行 <code>mastodon:setup</code>）。</li>
<li>停止旧服务器上的Mastodon（<code>systemctl stop 'mastodon-*.service'</code>）。</li>
<li>依照如下指示，导出并导入Postgres数据库。</li>
<li>依照如下指示，复制 <code>system/</code> 目录下文件。（注意：如果你使用S3存储，你可以跳过此步）。</li>
<li>复制 <code>.env.production</code> 文件。</li>
<li>运行 <code>RAILS_ENV=production bundle exec rails assets:precompile</code> 编译 Mastodon。</li>
<li>运行 <code>RAILS_ENV=production ./bin/tootctl feeds build</code> 重新构建每个用户的主页时间流。</li>
<li>启动新服务器上的Mastodon。</li>
<li>更新DNS设置，将其指向新服务器。</li>
<li>更新或复制你的Nginx设置，如果必要的话可重获取LetsEncrypt证书。</li>
<li>享受你的新服务器！</li>
</ol>
<h2 id="detailed-steps">详细步骤</h2>
<h3 id="what-data-needs-to-be-migrated">什么数据需要被迁移</h3>
<p>你必须需要复制如下内容：</p>
<ul>
<li><code>~/live/public/system</code>目录，里面包含了用户上传的图片与视频（如果使用S3，可跳过此步）</li>
<li>Postgres数据库（使用<a href="https://www.postgresql.org/docs/9.1/static/backup-dump.html">pg_dump</a>）</li>
<li><code>~/live/.env.production</code>文件，里面包含了服务器配置与密钥</li>
</ul>
<p>不太重要的部分，为了方便起见，你也可以复制如下内容：</p>
<ul>
<li>nginx配置文件（位于<code>/etc/nginx/sites-available/default</code>）</li>
<li>systemd配置文件（<code>/etc/systemd/system/mastodon-*.service</code>），里面可能包括一些你服务器的调优与个性化</li>
<li>pgbouncer配置文件，位于 <code>/etc/pgbouncer</code> （如果你使用pgbouncer的话）</li>
</ul>
<h3 id="dump-and-load-postgres">导出并导入Postgres数据库</h3>
<p>不要运行<code>mastodon:setup</code>，而是创建一个名为<code>template0</code>的空白Postgres数据库（当导入Postgres导出文件时，这是很有用的，参见<a href="https://www.postgresql.org/docs/9.1/static/backup-dump.html#BACKUP-DUMP-RESTORE">pg_dump文档</a>）。</p>
<p>在你的旧系统，使用<code>mastodon</code>用户运行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_dump -Fc mastodon_production -f backup.dump
</span></span></code></pre></div><p>使用 <code>rsync</code> 或 <code>scp</code> 复制 <code>backup.dump</code> 文件。然后在新系统，使用<code>mastodon</code>帐户创建一个空数据库：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>createdb -T template0 mastodon_production
</span></span></code></pre></div><p>然后导入它：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pg_restore -U mastodon -n public --no-owner --role<span style="color:#ff79c6">=</span>mastodon <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  -d mastodon_production backup.dump
</span></span></code></pre></div><p>（注意：如果新服务器上的帐户名不是<code>mastodon</code>，你应当修改上面命令中 <code>-U</code> <strong>和</strong> <code>--role</code> 参数。两台服务器的用户名不同也可以。）</p>
<h3 id="copy-files">复制文件</h3>
<p>本操作可能花费一些时间，若你希望避免不必要重复制，建议使用<code>rsync</code>。在你的旧机器上，使用<code>mastodon</code>用户，运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rsync -avz ~/live/public/system/ mastodon@example.com:~/live/public/system/
</span></span></code></pre></div><p>如果旧服务器上任何文件有改动，你需要重运行此命令。</p>
<p>你同样需要复制<code>.env.production</code>文件，该文件内含密钥。</p>
<p>可选的，你可以复制nginx、systemd、pgbouncer配置文件，或者从头开始重写它们。</p>
<h3 id="during-migration">迁移期间</h3>
<p>你可以编辑旧机器上的<code>~/live/public/500.html</code>页面，如果你希望展示一个优雅的错误信息，让现有用户知晓正在进行迁移。</p>
<p>你也应该提前一天将DNS TTL设置为较小数值（30-60分钟）。这样当你把DNS指向新IP后，新纪录可以很快扩散开来。</p>
<h3 id="after-migrating">迁移后</h3>
<p>你可以使用<a href="https://whatsmydns.net/">whatsmydns.net</a>来查看DNS扩散的过程。为了跳过这个过程，你可以修改你自己的<code>/etc/hosts</code>文件，将其指向你的新服务器，这样你可以尽早开始使用新服务器。</p>
<figure>
    <p>
        <strong>翻译状态：</strong>
        本文是英文页面 <a href="/admin/migrating/">Migrating to a new machine</a> 的翻译，最后翻译时间：2020-05-06，点击<a href="https://github.com/tootsuite/documentation/compare/ad1ef20f171c9f61439f32168987b0b4f9abd74b...master">这里</a>可以查看翻译后页面的改动。
    </p>
</figure>



    <p style="color: #687590;">
      最后更新于 May 21, 2020 · <a href='https://github.com/tootsuite/documentation/tree/master/content/zh-cn/admin/migrating.md' style="color: #687590;">改进此页面</a>

      
        <br />

        也可在此找到：

        
          <a href="https://documentation.sig.gy/admin/migrating/" style="color: #687590;" hreflang="en">English</a>
        
      
    </p>

  </div>
</main>
  </div>

  <footer class="footer container">
  <div class="sponsorship">
    <div class="container">
      <h2>
        Sponsored by
      </h2>

      <div class="logo-grid">
        <div>
          <a href="https://www.dotcom-monitor.com/es/">
            <img src="/assets/sponsors/dotcom-monitor-logo.png" alt="Dotcom-Monitor" />
          </a>

          <a href="https://www.loadview-testing.com/products/jmeter-load-testing/">
            <img src="/assets/sponsors/LoadView-logo.png" alt="LoadView" />
          </a>

          <a href="http://www.stevetures.com/">
            <img src="/assets/sponsors/stephen-tures.jpg" alt="Stephen Tures" />
          </a>

          <a href="https://swayable.com">
            <img src="/assets/sponsors/swayable.jpeg" alt="Swayable" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <p class="legal legal--right">
    <a href='https://joinmastodon.org'>加入Mastodon</a> · <a href='https://blog.joinmastodon.org'>博客</a> · <a href='https://mastodon.social/@Mastodon' target='_blank'><i class='fab fa-mastodon'></i></a> · <a href='https://twitter.com/joinmastodon' rel='nofollow' target='_blank'><i class='fab fa-twitter'></i></a>
  </p>

  <p class="legal"><a href='https://github.com/tootsuite/documentation/tree/master/content/zh-cn/admin/migrating.md'>查看源代码</a> · <a href='https://creativecommons.org/licenses/by-sa/4.0/'>CC BY-SA 4.0</a> · <a href='https://joinmastodon.org/imprint'>版权信息</a></p>
</footer>

</body>

</html>
